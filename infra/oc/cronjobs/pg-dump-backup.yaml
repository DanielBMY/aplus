apiVersion: batch/v2alpha1
kind: CronJob
metadata:
  name: pg-dump-backup-cron-dev
  namespace: dinsic-aplus
  labels:
    env: dev
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 6
  jobTemplate:
    metadata:
      labels:
        env: dev
    spec:
      template:
        metadata:
          labels:
            parent: pg-dump-backup-job
            env: dev
        spec:
          containers:
            - env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      key: database-url
                      name: aplus-preprod
                - name: DATABASE_NAME
                  value: aplus-preprod
                - name: DATABASE_BACKUP_PATH
                  value: /var/backups
                - name: RETENTION_DAYS
                  value: "30"
                - name: RECIPIENT_PUBLIC_KEY_B64
                  value: LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUVOQkYzbE9mVUJDQUN5OHlEMUJCUU45aEg0TitIN091RG9GQnY5SWtObllaOUQ4eTlQZzlBc3VSZEV5QVlhCk94dDh3Tm9CUzlHa1FMTVdnWGMwaytUT2tFcnZpaDd0T0NNZ0ljbmd5dlJnZnhabTVnMlFjaXVqbHc2NE5UU0EKRXdWWUdmVlJYT3VxQ3FJc1Z1U2xwYkswakloUFhwbnpOamZxY0k5UzVSRklFeWdXUGQ5K0ZRUnRoNlBMNjVVbAp3d1F2T0lNVTdrcDRXTUtEdTZtanVZVzF1a3dQQ0FobG9vQ05ENy90WVd5U2JzVHRqK05lZE5RaWRaNVNVNFdxClZ3YUEzTklqeXdEaXRwMVZSNUQxQi9Oa2p3elo4SXcxeW1xeTV2dzYrZ3JhZzJZOFV2dVdrR1lDQ2wwd09iR0EKY3JCK3R3UFV2aitWaUM3NTkzQVVxMDE3emZRMDZLRVkzZVRqQUJFQkFBRzBMRXgxWTJsbGJpQlFaWEpsYVhKaApJRHhzZFdOcFpXNHVjR1Z5WldseVlVQmlaWFJoTG1kdmRYWXVabkkraVFGVUJCTUJDQUErRmlFRTBaNlhxdzU3CnFDbHl5VzRuRE95c0dxdFp1VUFGQWwzbE9mVUNHd01GQ1FQQ1p3QUZDd2tJQndJR0ZRb0pDQXNDQkJZQ0F3RUMKSGdFQ0Y0QUFDZ2tRRE95c0dxdFp1VUJXSFFnQWgzZWtkME1iSXM3R21ZV2xNWFZlNFh3NWpTK0h4M25lMEs1OApkdHlHNjV2VHFuRzlNWUo0K2pGbDcrd3FuTC9kR2o0RGRhZjhWTGpqSzZpeGJISTRjYSthTDVvZm9xb3ZzSmxkClhsRm5vYlU3by93aGJHcnZhaUlKVlhlN1BaQTNiVldXQ25XZGZLYVo3d3ZGZTFHbUZTVlFPS3BKbkV6WDNMc0QKM0lSWVpWK0ptREpvUUtYWjliL1R2OXl2WEtxS1ROcEdIYmpaV0F6eVVMcGpVNTZMdEJDZTJQcDk4enEyZmphbgpNSE92Z2pVcDVjOW44OFl2TFVkL1pkTVAxa2pNc2NOaUVoZ21nTEZYRHdBQlZtVkNqQXJLcGdWU2VranJtTXczCmEvMzQ0ejkvYUUwUXFRT3ArWEtLNk9iTS9pUmgrSkdwaHZSaWZTbXRoazRmSVdOMmdya0JEUVJkNVRuMUFRZ0EKdmdYTUluVTV4Y2VmU0tKdEZ1Nkh1WlBsNTlNRXRyTE1IV2Y4SnpVNjBWUENPcE5KZjBuMFN3K1pZZVVHb0QzdApwVWpTaWZwNm5kVE51NUg0eVdmc21iSG9tZmRmUEVGNkhUZ3VLOWMyUXlVaVJoYXZxeFo4clFaUVVFYUxSclQwCm9rL2RSa0tIblZkeHNvWE84R2xNVG1WS2lCeGpzdnprTE9DVTRNVkFHc3FtVDJlY3RNcjNrYkUwM0U3L2RPb3gKZTdRTnV3ZDUvRHRYZ2JSQTkyRWUzVzJjc1gwaGx2Vk9uWUIzTFpLSWVjN0JlVERaVTZKSVVhVUxTVW5ocFk3NwplM2kxVUtYSjVTWDZuK1FzR3doc3pFS2pIVU1PQlRzYTBLVGx6QmVSR3Z3WFlsQzVFclRCTHdGVW5HU3h6RTdYCjdHRnpKaTRTNUg2dU11K0JDZmh1U3dBUkFRQUJpUUU4QkJnQkNBQW1GaUVFMFo2WHF3NTdxQ2x5eVc0bkRPeXMKR3F0WnVVQUZBbDNsT2ZVQ0d3d0ZDUVBDWndBQUNna1FET3lzR3F0WnVVRDZFd2YrT0xWSDR0THArZDhGMUdCcwpkWC9USjdUczBhc0pRNE03MDNrUExMOU00bDBjREJ6dnl1eHRSdDcvL21uQVNKdHEva29DaDZueWZreENJbk0zCnNTcExtTzhic25OSzNUWHhmUzk0R3JIdW1kRUVabTRMdmt2cngvOW1PZ05kaHR4YzJqMktRTzUybGE1K0lRL00KVGtUOVlRNnNIcXBqbCtnbUNkamNTbEtvNUVSNGMybmZsTytqaE5MMVVrdlBsUnVTTE50M2VCZ0pEVnNzNFJIZApILzRZWW5jMWVsbTIrajJXWVRMNWMyQmVMekNKN3hHK29tL2IzUmxKTFNIbDlQUGd4OVBNck9VRjBucWVsL1g1CnQzUi8vSzh6Qkk0ZnVOWGl0NlNWYm9SUFFRcjJDRzZaSVVUSTduWUs4RXRENnduekF5YUtTckR0TGY3dTc4SFUKRFZtZXd3PT0KPWJjeXgKLS0tLS1FTkQgUEdQIFBVQkxJQyBLRVkgQkxPQ0stLS0tLQo=
                - name: RECIPIENT_PUBLIC_KEY_EMAIL
                  value: lucien.pereira@beta.gouv.fr
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      key: aws-access-key-id
                      name: aplus-aws-s3-preprod
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      key: aws-secret-access-key
                      name: aplus-aws-s3-preprod
                - name: AWS_DEFAULT_REGION
                  valueFrom:
                    secretKeyRef:
                      key: aws-default-region
                      name: aplus-aws-s3-preprod
                - name: AWS_BUCKET_NAME
                  valueFrom:
                    secretKeyRef:
                      key: aws-bucket-name
                      name: aplus-aws-s3-preprod
              image: 172.30.8.127:5000/dinsic-aplus/pg-dump-backup:dev
              imagePullPolicy: Always
              name: pg-dump-backup
              resources:
                limits:
                  cpu: 250m
                  memory: 256Mi
                requests:
                  cpu: 250m
                  memory: 256Mi
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
              volumeMounts:
                - mountPath: /var/backups
                  name: db-backups
          dnsPolicy: ClusterFirst
          restartPolicy: OnFailure
          schedulerName: default-scheduler
          securityContext: {}
          terminationGracePeriodSeconds: 30
          volumes:
            - name: db-backups
              persistentVolumeClaim:
                claimName: aplus-prep-prod-files
  schedule: "* */24 * * *"
  successfulJobsHistoryLimit: 30
  suspend: false